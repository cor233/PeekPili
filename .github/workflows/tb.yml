name: 同步PeekPili

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

permissions:
  contents: write

jobs:
  sync-code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - run: git remote add upstream https://github.com/ingriddaleusag-dotcom/PeekPiliRelease.git
      - run: git fetch upstream --tags --force
      - env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push --force --all "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git push --force --tags "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

  sync-releases:
    runs-on: ubuntu-latest
    needs: sync-code
    steps:
      - env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SOURCE_REPO="ingriddaleusag-dotcom/PeekPiliRelease"
          gh release list --repo "$SOURCE_REPO" --limit 1000 --json tagName,body,isPrerelease,isDraft,assets --jq '.[] | @base64' > releases_b64.txt
      - env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SOURCE_REPO="ingriddaleusag-dotcom/PeekPiliRelease"
          TARGET_REPO="${{ github.repository }}"
          while read release_b64; do
            [ -z "$release_b64" ] && continue
            release=$(echo "$release_b64" | base64 --decode)
            TAG_NAME=$(echo "$release" | jq -r '.tagName')
            BODY=$(echo "$release" | jq -r '.body // ""')
            IS_PRERELEASE=$(echo "$release" | jq -r '.isPrerelease')
            IS_DRAFT=$(echo "$release" | jq -r '.isDraft')
            if gh release view "$TAG_NAME" --repo "$TARGET_REPO" &>/dev/null; then
              continue
            fi
            echo "$BODY" > body.txt
            PRERELEASE_FLAG=""
            [ "$IS_PRERELEASE" = "true" ] && PRERELEASE_FLAG="--prerelease"
            DRAFT_FLAG=""
            [ "$IS_DRAFT" = "true" ] && DRAFT_FLAG="--draft"
            if ! gh release create "$TAG_NAME" --repo "$TARGET_REPO" --title "$TAG_NAME" --notes-file body.txt $PRERELEASE_FLAG $DRAFT_FLAG; then
              exit 1
            fi
            ASSETS=$(echo "$release" | jq -r '.assets[]?.url')
            if [ -n "$ASSETS" ]; then
              echo "$ASSETS" | while read asset_url; do
                asset_name=$(echo "$release" | jq -r --arg url "$asset_url" '.assets[] | select(.url==$url) | .name')
                curl -s -fL -H "Authorization: token $GH_TOKEN" -H "Accept: application/octet-stream" "$asset_url" -o "$asset_name"
                gh release upload "$TAG_NAME" "$asset_name" --repo "$TARGET_REPO" --clobber
                rm -f "$asset_name"
              done
            fi
            rm -f body.txt
          done < releases_b64.txt
